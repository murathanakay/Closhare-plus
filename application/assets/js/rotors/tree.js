(function($,window,document,undefined){if($.ui.fancytree&&$.ui.fancytree.version){$.ui.fancytree.warn("Fancytree: ignored duplicate include");return}function _raiseNotImplemented(msg){msg=msg||"";$.error("Not implemented: "+msg)}function _assert(cond,msg){if(!cond){msg=msg?": "+msg:"";$.error("Assertion failed"+msg)}}function consoleApply(method,args){var i,s,fn=window.console?window.console[method]:null;if(fn)if(fn.apply)fn.apply(window.console,args);else{s="";for(i=0;i<args.length;i++)s+=args[i];
fn(s)}}function isVersionAtLeast(dottedVersion,major,minor,patch){var i,v,t,verParts=$.map($.trim(dottedVersion).split("."),function(e){return parseInt(e,10)}),testParts=$.map(Array.prototype.slice.call(arguments,1),function(e){return parseInt(e,10)});for(i=0;i<testParts.length;i++){v=verParts[i]||0;t=testParts[i]||0;if(v!==t)return v>t}return true}function _makeVirtualFunction(methodName,tree,base,extension,extName){var proxy=function(){var prevFunc=tree[methodName],baseFunc=extension[methodName],
_local=tree.ext[extName],_super=function(){return prevFunc.apply(tree,arguments)};return function(){var prevLocal=tree._local,prevSuper=tree._super;try{tree._local=_local;tree._super=_super;return baseFunc.apply(tree,arguments)}finally{tree._local=prevLocal;tree._super=prevSuper}}}();return proxy}function _subclassObject(tree,base,extension,extName){for(var attrName in extension)if(typeof extension[attrName]==="function")if(typeof tree[attrName]==="function")tree[attrName]=_makeVirtualFunction(attrName,
tree,base,extension,extName);else if(attrName.charAt(0)==="_")tree.ext[extName][attrName]=_makeVirtualFunction(attrName,tree,base,extension,extName);else $.error("Could not override tree."+attrName+". Use prefix '_' to create tree."+extName+"._"+attrName);else if(attrName!=="options")tree.ext[extName][attrName]=extension[attrName]}function _getResolvedPromise(context,argArray){if(context===undefined)return $.Deferred(function(){this.resolve()}).promise();else return $.Deferred(function(){this.resolveWith(context,
argArray)}).promise()}function _getRejectedPromise(context,argArray){if(context===undefined)return $.Deferred(function(){this.reject()}).promise();else return $.Deferred(function(){this.rejectWith(context,argArray)}).promise()}function _makeResolveFunc(deferred,context){return function(){deferred.resolveWith(context)}}function _makeNodeTitleMatcher(s){s=s.toLowerCase();return function(node){return node.title.toLowerCase().indexOf(s)>=0}}var i,FT=null,CLASS_ATTRS="active expanded focus folder hideCheckbox lazy selected unselectable".split(" "),
CLASS_ATTR_MAP={},NODE_ATTRS="expanded extraClasses folder hideCheckbox key lazy selected title tooltip unselectable".split(" "),NODE_ATTR_MAP={},NONE_NODE_DATA_MAP={"active":true,"children":true,"data":true,"focus":true};for(i=0;i<CLASS_ATTRS.length;i++)CLASS_ATTR_MAP[CLASS_ATTRS[i]]=true;for(i=0;i<NODE_ATTRS.length;i++)NODE_ATTR_MAP[NODE_ATTRS[i]]=true;function FancytreeNode(parent,obj){var i,l,name,cl;this.parent=parent;this.tree=parent.tree;this.ul=null;this.li=null;this.statusNodeType=null;this._isLoading=
false;this.data={};for(i=0,l=NODE_ATTRS.length;i<l;i++){name=NODE_ATTRS[i];this[name]=obj[name]}if(obj.data)$.extend(this.data,obj.data);for(name in obj)if(!NODE_ATTR_MAP[name]&&(!$.isFunction(obj[name])&&!NONE_NODE_DATA_MAP[name]))this.data[name]=obj[name];if(this.key==null)this.key="_"+FT._nextNodeKey++;if(obj.active){_assert(this.tree.activeNode===null,"only one active node allowed");this.tree.activeNode=this}this.children=null;cl=obj.children;if(cl&&cl.length)this._setChildren(cl)}FancytreeNode.prototype=
{_findDirectChild:function(ptr){var i,l,cl=this.children;if(cl)if(typeof ptr==="string")for(i=0,l=cl.length;i<l;i++){if(cl[i].key===ptr)return cl[i]}else if(typeof ptr==="number")return this.children[ptr];else if(ptr.parent===this)return ptr;return null},_setChildren:function(children){_assert(children&&(!this.children||this.children.length===0),"only init supported");this.children=[];for(var i=0,l=children.length;i<l;i++)this.children.push(new FancytreeNode(this,children[i]))},addChildren:function(children,
insertBefore){var i,l,pos,firstNode=null,nodeList=[];if($.isPlainObject(children))children=[children];if(!this.children)this.children=[];for(i=0,l=children.length;i<l;i++)nodeList.push(new FancytreeNode(this,children[i]));firstNode=nodeList[0];if(insertBefore==null)this.children=this.children.concat(nodeList);else{insertBefore=this._findDirectChild(insertBefore);pos=$.inArray(insertBefore,this.children);_assert(pos>=0,"insertBefore must be an existing child");this.children.splice.apply(this.children,
[pos,0].concat(nodeList))}if(!this.parent||(this.parent.ul||this.tr))this.render();if(this.tree.options.selectMode===3)this.fixSelection3FromEndNodes();return firstNode},addNode:function(node,mode){if(mode===undefined||mode==="over")mode="child";switch(mode){case "after":return this.getParent().addChildren(node,this.getNextSibling());case "before":return this.getParent().addChildren(node,this);case "child":case "over":return this.addChildren(node)}_assert(false,"Invalid mode: "+mode)},applyPatch:function(patch){if(patch===
null){this.remove();return _getResolvedPromise(this)}var name,promise,v,IGNORE_MAP={children:true,expanded:true,parent:true};for(name in patch){v=patch[name];if(!IGNORE_MAP[name]&&!$.isFunction(v))if(NODE_ATTR_MAP[name])this[name]=v;else this.data[name]=v}if(patch.hasOwnProperty("children")){this.removeChildren();if(patch.children)this._setChildren(patch.children)}if(this.isVisible()){this.renderTitle();this.renderStatus()}if(patch.hasOwnProperty("expanded"))promise=this.setExpanded(patch.expanded);
else promise=_getResolvedPromise(this);return promise},collapseSiblings:function(){return this.tree._callHook("nodeCollapseSiblings",this)},copyTo:function(node,mode,map){return node.addNode(this.toDict(true,map),mode)},countChildren:function(deep){var cl=this.children,i,l,n;if(!cl)return 0;n=cl.length;if(deep!==false)for(i=0,l=n;i<l;i++)n+=cl[i].countChildren();return n},debug:function(msg){if(this.tree.options.debugLevel>=2){Array.prototype.unshift.call(arguments,this.toString());consoleApply("debug",
arguments)}},discard:function(){this.warn("FancytreeNode.discard() is deprecated since 2014-02-16. Use .resetLazy() instead.");return this.resetLazy()},findAll:function(match){match=$.isFunction(match)?match:_makeNodeTitleMatcher(match);var res=[];this.visit(function(n){if(match(n))res.push(n)});return res},findFirst:function(match){match=$.isFunction(match)?match:_makeNodeTitleMatcher(match);var res=null;this.visit(function(n){if(match(n)){res=n;return false}});return res},_changeSelectStatusAttrs:function(state){var changed=
false;switch(state){case false:changed=this.selected||this.partsel;this.selected=false;this.partsel=false;break;case true:changed=!this.selected||!this.partsel;this.selected=true;this.partsel=true;break;case undefined:changed=this.selected||!this.partsel;this.selected=false;this.partsel=true;break;default:_assert(false,"invalid state: "+state)}if(changed)this.renderStatus();return changed},fixSelection3AfterClick:function(){var flag=this.isSelected();this.visit(function(node){node._changeSelectStatusAttrs(flag)});
this.fixSelection3FromEndNodes()},fixSelection3FromEndNodes:function(){_assert(this.tree.options.selectMode===3,"expected selectMode 3");function _walk(node){var i,l,child,s,state,allSelected,someSelected,children=node.children;if(children){allSelected=true;someSelected=false;for(i=0,l=children.length;i<l;i++){child=children[i];s=_walk(child);if(s!==false)someSelected=true;if(s!==true)allSelected=false}state=allSelected?true:someSelected?undefined:false}else state=!!node.selected;node._changeSelectStatusAttrs(state);
return state}_walk(this);this.visitParents(function(node){var i,l,child,state,children=node.children,allSelected=true,someSelected=false;for(i=0,l=children.length;i<l;i++){child=children[i];if(child.selected||child.partsel)someSelected=true;if(!child.unselectable&&!child.selected)allSelected=false}state=allSelected?true:someSelected?undefined:false;node._changeSelectStatusAttrs(state)})},fromDict:function(dict){for(var name in dict)if(NODE_ATTR_MAP[name])this[name]=dict[name];else if(name==="data")$.extend(this.data,
dict.data);else if(!$.isFunction(dict[name])&&!NONE_NODE_DATA_MAP[name])this.data[name]=dict[name];if(dict.children){this.removeChildren();this.addChildren(dict.children)}else this.renderTitle()},getChildren:function(){if(this.hasChildren()===undefined)return undefined;return this.children},getFirstChild:function(){return this.children?this.children[0]:null},getIndex:function(){return $.inArray(this,this.parent.children)},getIndexHier:function(separator){separator=separator||".";var res=[];$.each(this.getParentList(false,
true),function(i,o){res.push(o.getIndex()+1)});return res.join(separator)},getKeyPath:function(excludeSelf){var path=[],sep=this.tree.options.keyPathSeparator;this.visitParents(function(n){if(n.parent)path.unshift(n.key)},!excludeSelf);return sep+path.join(sep)},getLastChild:function(){return this.children?this.children[this.children.length-1]:null},getLevel:function(){var level=0,dtn=this.parent;while(dtn){level++;dtn=dtn.parent}return level},getNextSibling:function(){if(this.parent){var i,l,ac=
this.parent.children;for(i=0,l=ac.length-1;i<l;i++)if(ac[i]===this)return ac[i+1]}return null},getParent:function(){return this.parent},getParentList:function(includeRoot,includeSelf){var l=[],dtn=includeSelf?this:this.parent;while(dtn){if(includeRoot||dtn.parent)l.unshift(dtn);dtn=dtn.parent}return l},getPrevSibling:function(){if(this.parent){var i,l,ac=this.parent.children;for(i=1,l=ac.length;i<l;i++)if(ac[i]===this)return ac[i-1]}return null},hasChildren:function(){if(this.lazy){if(this.children==
null)return undefined;else if(this.children.length===0)return false;else if(this.children.length===1&&this.children[0].isStatusNode())return undefined;return true}return!!this.children},hasFocus:function(){return this.tree.hasFocus()&&this.tree.focusNode===this},isActive:function(){return this.tree.activeNode===this},isChildOf:function(otherNode){return this.parent&&this.parent===otherNode},isDescendantOf:function(otherNode){if(!otherNode||otherNode.tree!==this.tree)return false;var p=this.parent;
while(p){if(p===otherNode)return true;p=p.parent}return false},isExpanded:function(){return!!this.expanded},isFirstSibling:function(){var p=this.parent;return!p||p.children[0]===this},isFolder:function(){return!!this.folder},isLastSibling:function(){var p=this.parent;return!p||p.children[p.children.length-1]===this},isLazy:function(){return!!this.lazy},isLoaded:function(){return!this.lazy||this.hasChildren()!==undefined},isLoading:function(){return!!this._isLoading},isRoot:function(){return this.tree.rootNode===
this},isSelected:function(){return!!this.selected},isStatusNode:function(){return!!this.statusNodeType},isUndefined:function(){return this.hasChildren()===undefined},isVisible:function(){var i,l,parents=this.getParentList(false,false);for(i=0,l=parents.length;i<l;i++)if(!parents[i].expanded)return false;return true},lazyLoad:function(discard){this.warn("FancytreeNode.lazyLoad() is deprecated since 2014-02-16. Use .load() instead.");return this.load(discard)},load:function(forceReload){var res,source,
that=this;_assert(this.isLazy(),"load() requires a lazy node");_assert(forceReload||this.isUndefined(),"Pass forceReload=true to re-load a lazy node");if(this.isLoaded())this.resetLazy();source=this.tree._triggerNodeEvent("lazyLoad",this);_assert(typeof source!=="boolean","lazyLoad event must return source in data.result");res=this.tree._callHook("nodeLoadChildren",this,source);if(this.expanded)res.always(function(){that.render()});return res},makeVisible:function(opts){var i,that=this,deferreds=
[],dfd=new $.Deferred,parents=this.getParentList(false,false),len=parents.length,effects=!(opts&&opts.noAnimation===true),scroll=!(opts&&opts.scrollIntoView===false);for(i=len-1;i>=0;i--)deferreds.push(parents[i].setExpanded(true,opts));$.when.apply($,deferreds).done(function(){if(scroll)that.scrollIntoView(effects).done(function(){dfd.resolve()});else dfd.resolve()});return dfd.promise()},moveTo:function(targetNode,mode,map){if(mode===undefined||mode==="over")mode="child";var pos,prevParent=this.parent,
targetParent=mode==="child"?targetNode:targetNode.parent;if(this===targetNode)return;else if(!this.parent)throw"Cannot move system root";else if(targetParent.isDescendantOf(this))throw"Cannot move a node to its own descendant";if(this.parent.children.length===1){this.parent.children=this.parent.lazy?[]:null;this.parent.expanded=false}else{pos=$.inArray(this,this.parent.children);_assert(pos>=0);this.parent.children.splice(pos,1)}this.parent=targetParent;if(targetParent.hasChildren())switch(mode){case "child":targetParent.children.push(this);
break;case "before":pos=$.inArray(targetNode,targetParent.children);_assert(pos>=0);targetParent.children.splice(pos,0,this);break;case "after":pos=$.inArray(targetNode,targetParent.children);_assert(pos>=0);targetParent.children.splice(pos+1,0,this);break;default:throw"Invalid mode "+mode;}else targetParent.children=[this];if(map)targetNode.visit(map,true);if(this.tree!==targetNode.tree){this.warn("Cross-tree moveTo is experimantal!");this.visit(function(n){n.tree=targetNode.tree},true)}if(!prevParent.isDescendantOf(targetParent))prevParent.render();
if(!targetParent.isDescendantOf(prevParent)&&targetParent!==prevParent)targetParent.render()},navigate:function(where,activate){var i,parents,handled=true,KC=$.ui.keyCode,sib=null;function _goto(n){if(n){n.makeVisible();if(!$(n.span).is(":visible")){n.debug("Navigate: skipping hidden node");n.navigate(where,activate);return}return activate===false?n.setFocus():n.setActive()}}switch(where){case KC.BACKSPACE:if(this.parent&&this.parent.parent)_goto(this.parent);break;case KC.LEFT:if(this.expanded){this.setExpanded(false);
_goto(this)}else if(this.parent&&this.parent.parent)_goto(this.parent);break;case KC.RIGHT:if(!this.expanded&&(this.children||this.lazy)){this.setExpanded();_goto(this)}else if(this.children&&this.children.length)_goto(this.children[0]);break;case KC.UP:sib=this.getPrevSibling();while(sib&&(sib.expanded&&(sib.children&&sib.children.length)))sib=sib.children[sib.children.length-1];if(!sib&&(this.parent&&this.parent.parent))sib=this.parent;_goto(sib);break;case KC.DOWN:if(this.expanded&&(this.children&&
this.children.length))sib=this.children[0];else{parents=this.getParentList(false,true);for(i=parents.length-1;i>=0;i--){sib=parents[i].getNextSibling();if(sib)break}}_goto(sib);break;default:handled=false}},remove:function(){return this.parent.removeChild(this)},removeChild:function(childNode){return this.tree._callHook("nodeRemoveChild",this,childNode)},removeChildren:function(){return this.tree._callHook("nodeRemoveChildren",this)},render:function(force,deep){return this.tree._callHook("nodeRender",
this,force,deep)},renderTitle:function(){return this.tree._callHook("nodeRenderTitle",this)},renderStatus:function(){return this.tree._callHook("nodeRenderStatus",this)},resetLazy:function(){this.removeChildren();this.expanded=false;this.lazy=true;this.children=undefined;this.renderStatus()},scheduleAction:function(mode,ms){if(this.tree.timer)clearTimeout(this.tree.timer);this.tree.timer=null;var self=this;switch(mode){case "cancel":break;case "expand":this.tree.timer=setTimeout(function(){self.tree.debug("setTimeout: trigger expand");
self.setExpanded(true)},ms);break;case "activate":this.tree.timer=setTimeout(function(){self.tree.debug("setTimeout: trigger activate");self.setActive(true)},ms);break;default:throw"Invalid mode "+mode;}},scrollIntoView:function(effects,topNode){effects=effects===true?{duration:200,queue:false}:effects;var topNodeY,dfd=new $.Deferred,that=this,nodeY=$(this.span).position().top,nodeHeight=$(this.span).height(),$container=this.tree.$container,scrollTop=$container[0].scrollTop,horzScrollHeight=Math.max(0,
$container.innerHeight()-$container[0].clientHeight),containerHeight=$container.height()-horzScrollHeight,newScrollTop=null;if(nodeY<0)newScrollTop=scrollTop+nodeY;else if(nodeY+nodeHeight>containerHeight){newScrollTop=scrollTop+nodeY-containerHeight+nodeHeight;if(topNode){topNodeY=topNode?$(topNode.span).position().top:0;if(nodeY-topNodeY>containerHeight)newScrollTop=scrollTop+topNodeY}}if(newScrollTop!==null)if(effects){effects.complete=function(){dfd.resolveWith(that)};$container.animate({scrollTop:newScrollTop},
effects)}else{$container[0].scrollTop=newScrollTop;dfd.resolveWith(this)}else dfd.resolveWith(this);return dfd.promise()},setActive:function(flag,opts){return this.tree._callHook("nodeSetActive",this,flag,opts)},setExpanded:function(flag,opts){return this.tree._callHook("nodeSetExpanded",this,flag,opts)},setFocus:function(flag){return this.tree._callHook("nodeSetFocus",this,flag)},setSelected:function(flag){return this.tree._callHook("nodeSetSelected",this,flag)},setTitle:function(title){this.title=
title;this.renderTitle()},sortChildren:function(cmp,deep){var i,l,cl=this.children;if(!cl)return;cmp=cmp||function(a,b){var x=a.title.toLowerCase(),y=b.title.toLowerCase();return x===y?0:x>y?1:-1};cl.sort(cmp);if(deep)for(i=0,l=cl.length;i<l;i++)if(cl[i].children)cl[i].sortChildren(cmp,"$norender$");if(deep!=="$norender$")this.render()},toDict:function(recursive,callback){var i,l,node,dict={},self=this;$.each(NODE_ATTRS,function(i,a){if(self[a]||self[a]===false)dict[a]=self[a]});if(!$.isEmptyObject(this.data)){dict.data=
$.extend({},this.data);if($.isEmptyObject(dict.data))delete dict.data}if(callback)callback(dict);if(recursive)if(this.hasChildren()){dict.children=[];for(i=0,l=this.children.length;i<l;i++){node=this.children[i];if(!node.isStatusNode())dict.children.push(node.toDict(true,callback))}}else;return dict},toggleExpanded:function(){return this.tree._callHook("nodeToggleExpanded",this)},toggleSelected:function(){return this.tree._callHook("nodeToggleSelected",this)},toString:function(){return"<FancytreeNode(#"+
this.key+", '"+this.title+"')>"},visit:function(fn,includeSelf){var i,l,res=true,children=this.children;if(includeSelf===true){res=fn(this);if(res===false||res==="skip")return res}if(children)for(i=0,l=children.length;i<l;i++){res=children[i].visit(fn,true);if(res===false)break}return res},visitParents:function(fn,includeSelf){if(includeSelf&&fn(this)===false)return false;var p=this.parent;while(p){if(fn(p)===false)return false;p=p.parent}return true},warn:function(msg){Array.prototype.unshift.call(arguments,
this.toString());consoleApply("warn",arguments)}};function Fancytree(widget){this.widget=widget;this.$div=widget.element;this.options=widget.options;if(this.options&&$.isFunction(this.options.lazyload))if(!$.isFunction(this.options.lazyLoad))this.options.lazyLoad=function(){FT.warn("The 'lazyload' event is deprecated since 2014-02-25. Use 'lazyLoad' (with uppercase L) instead.");widget.options.lazyload.apply(this,arguments)};this.ext={};this.data={};this._id=$.ui.fancytree._nextId++;this._ns=".fancytree-"+
this._id;this.activeNode=null;this.focusNode=null;this._hasFocus=null;this.lastSelectedNode=null;this.systemFocusElement=null,this.statusClassPropName="span";this.ariaPropName="li";this.nodeContainerAttrName="li";this.$div.find(">ul.fancytree-container").remove();var fakeParent={tree:this},$ul;this.rootNode=new FancytreeNode(fakeParent,{title:"root",key:"root_"+this._id,children:null,expanded:true});this.rootNode.parent=null;$ul=$("<ul>",{"class":"ui-fancytree fancytree-container"}).appendTo(this.$div);
this.$container=$ul;this.rootNode.ul=$ul[0];if(this.options.debugLevel==null)this.options.debugLevel=FT.debugLevel;this.$container.attr("tabindex",this.options.tabbable?"0":"-1");if(this.options.aria)this.$container.attr("role","tree").attr("aria-multiselectable",true)}Fancytree.prototype={_makeHookContext:function(obj,originalEvent,extra){var ctx,tree;if(obj.node!==undefined){if(originalEvent&&obj.originalEvent!==originalEvent)$.error("invalid args");ctx=obj}else if(obj.tree){tree=obj.tree;ctx={node:obj,
tree:tree,widget:tree.widget,options:tree.widget.options,originalEvent:originalEvent}}else if(obj.widget)ctx={node:null,tree:obj,widget:obj.widget,options:obj.widget.options,originalEvent:originalEvent};else $.error("invalid args");if(extra)$.extend(ctx,extra);return ctx},_callHook:function(funcName,contextObject,_extraArgs){var ctx=this._makeHookContext(contextObject),fn=this[funcName],args=Array.prototype.slice.call(arguments,2);if(!$.isFunction(fn))$.error("_callHook('"+funcName+"') is not a function");
args.unshift(ctx);return fn.apply(this,args)},_requireExtension:function(name,required,before,message){before=!!before;var thisName=this._local.name,extList=this.options.extensions,isBefore=$.inArray(name,extList)<$.inArray(thisName,extList),isMissing=required&&this.ext[name]==null,badOrder=!isMissing&&(before!=null&&before!==isBefore);_assert(thisName&&thisName!==name);if(isMissing||badOrder){if(!message)if(isMissing||required){message="'"+thisName+"' extension requires '"+name+"'";if(badOrder)message+=
" to be registered "+(before?"before":"after")+" itself"}else message="If used together, `"+name+"` must be registered "+(before?"before":"after")+" `"+thisName+"`";$.error(message);return false}return true},activateKey:function(key){var node=this.getNodeByKey(key);if(node)node.setActive();else if(this.activeNode)this.activeNode.setActive(false);return node},applyPatch:function(patchList){var dfd,i,p2,key,patch,node,patchCount=patchList.length,deferredList=[];for(i=0;i<patchCount;i++){p2=patchList[i];
_assert(p2.length===2,"patchList must be an array of length-2-arrays");key=p2[0];patch=p2[1];node=key===null?this.rootNode:this.getNodeByKey(key);if(node){dfd=new $.Deferred;deferredList.push(dfd);node.applyPatch(patch).always(_makeResolveFunc(dfd,node))}else this.warn("could not find node with key '"+key+"'")}return $.when.apply($,deferredList).promise()},count:function(){return this.rootNode.countChildren()},debug:function(msg){if(this.options.debugLevel>=2){Array.prototype.unshift.call(arguments,
this.toString());consoleApply("debug",arguments)}},generateFormElements:function(selected,active){var nodeList,selectedName=selected!==false?"ft_"+this._id:selected,activeName=active!==false?"ft_"+this._id+"_active":active,id="fancytree_result_"+this._id,$result=this.$container.find("div#"+id);if($result.length)$result.empty();else $result=$("<div>",{id:id}).hide().appendTo(this.$container);if(selectedName){nodeList=this.getSelectedNodes(this.options.selectMode===3);$.each(nodeList,function(idx,node){$result.append($("<input>",
{type:"checkbox",name:selectedName,value:node.key,checked:true}))})}if(activeName&&this.activeNode)$result.append($("<input>",{type:"radio",name:activeName,value:this.activeNode.key,checked:true}))},getActiveNode:function(){return this.activeNode},getFirstChild:function(){return this.rootNode.getFirstChild()},getFocusNode:function(ifTreeHasFocus){return this.focusNode},getNodeByKey:function(key,searchRoot){var el,match;if(!searchRoot){el=document.getElementById(this.options.idPrefix+key);if(el)return el.ftnode?
el.ftnode:null}searchRoot=searchRoot||this.rootNode;match=null;searchRoot.visit(function(node){if(node.key===key){match=node;return false}},true);return match},getSelectedNodes:function(stopOnParents){var nodeList=[];this.rootNode.visit(function(node){if(node.selected){nodeList.push(node);if(stopOnParents===true)return"skip"}});return nodeList},hasFocus:function(){return!!this._hasFocus},info:function(msg){if(this.options.debugLevel>=1){Array.prototype.unshift.call(arguments,this.toString());consoleApply("info",
arguments)}},loadKeyPath:function(keyPathList,callback,_rootNode){var deferredList,dfd,i,path,key,loadMap,node,segList,root=_rootNode||this.rootNode,sep=this.options.keyPathSeparator,self=this;if(!$.isArray(keyPathList))keyPathList=[keyPathList];loadMap={};for(i=0;i<keyPathList.length;i++){path=keyPathList[i];if(path.charAt(0)===sep)path=path.substr(1);segList=path.split(sep);while(segList.length){key=segList.shift();node=root._findDirectChild(key);if(!node){this.warn("loadKeyPath: key not found: "+
key+" (parent: "+root+")");callback.call(this,key,"error");break}else if(segList.length===0){callback.call(this,node,"ok");break}else if(!node.lazy||node.hasChildren()!==undefined){callback.call(this,node,"loaded");root=node}else{callback.call(this,node,"loaded");if(loadMap[key])loadMap[key].push(segList.join(sep));else loadMap[key]=[segList.join(sep)];break}}}deferredList=[];function __lazyload(key,node,dfd){callback.call(self,node,"loading");node.load().done(function(){self.loadKeyPath.call(self,
loadMap[key],callback,node).always(_makeResolveFunc(dfd,self))}).fail(function(errMsg){self.warn("loadKeyPath: error loading: "+key+" (parent: "+root+")");callback.call(self,node,"error");dfd.reject()})}for(key in loadMap){node=root._findDirectChild(key);dfd=new $.Deferred;deferredList.push(dfd);__lazyload(key,node,dfd)}return $.when.apply($,deferredList).promise()},reactivate:function(setFocus){var node=this.activeNode;if(node){this.activeNode=null;node.setActive();if(setFocus)node.setFocus()}},
reload:function(source){this._callHook("treeClear",this);return this._callHook("treeLoad",this,source)},render:function(force,deep){return this.rootNode.render(force,deep)},setFocus:function(flag){return this._callHook("treeSetFocus",this,flag)},toDict:function(includeRoot,callback){var res=this.rootNode.toDict(true,callback);return includeRoot?res:res.children},toString:function(){return"<Fancytree(#"+this._id+")>"},_triggerNodeEvent:function(type,node,originalEvent,extra){var ctx=this._makeHookContext(node,
originalEvent,extra),res=this.widget._trigger(type,originalEvent,ctx);if(res!==false&&ctx.result!==undefined)return ctx.result;return res},_triggerTreeEvent:function(type,originalEvent){var ctx=this._makeHookContext(this,originalEvent),res=this.widget._trigger(type,originalEvent,ctx);if(res!==false&&ctx.result!==undefined)return ctx.result;return res},visit:function(fn){return this.rootNode.visit(fn,false)},warn:function(msg){Array.prototype.unshift.call(arguments,this.toString());consoleApply("warn",
arguments)}};$.extend(Fancytree.prototype,{nodeClick:function(ctx){var activate,expand,event=ctx.originalEvent,targetType=ctx.targetType,node=ctx.node;if(targetType==="expander")this._callHook("nodeToggleExpanded",ctx);else if(targetType==="checkbox"){this._callHook("nodeToggleSelected",ctx);this._callHook("nodeSetFocus",ctx,true)}else{expand=false;activate=true;if(node.folder)switch(ctx.options.clickFolderMode){case 2:expand=true;activate=false;break;case 3:activate=true;expand=true;break}if(activate){this.nodeSetFocus(ctx);
this._callHook("nodeSetActive",ctx,true)}if(expand){if(!activate);this._callHook("nodeToggleExpanded",ctx)}}if(event.target.localName==="a"&&event.target.className==="fancytree-title")event.preventDefault()},nodeCollapseSiblings:function(ctx,callOpts){var ac,i,l,node=ctx.node;if(node.parent){ac=node.parent.children;for(i=0,l=ac.length;i<l;i++)if(ac[i]!==node&&ac[i].expanded)this._callHook("nodeSetExpanded",ac[i],false,callOpts)}},nodeDblclick:function(ctx){if(ctx.targetType==="title"&&ctx.options.clickFolderMode===
4)this._callHook("nodeToggleExpanded",ctx);if(ctx.targetType==="title")ctx.originalEvent.preventDefault()},nodeKeydown:function(ctx){var res,event=ctx.originalEvent,node=ctx.node,tree=ctx.tree,opts=ctx.options,handled=true,activate=!(event.ctrlKey||!opts.autoActivate),KC=$.ui.keyCode;if(!node){this.rootNode.getFirstChild().setFocus();node=ctx.node=this.focusNode;node.debug("Keydown force focus on first node")}switch(event.which){case KC.NUMPAD_ADD:case 187:tree.nodeSetExpanded(ctx,true);break;case KC.NUMPAD_SUBTRACT:case 189:tree.nodeSetExpanded(ctx,
false);break;case KC.SPACE:if(opts.checkbox)tree.nodeToggleSelected(ctx);else tree.nodeSetActive(ctx,true);break;case KC.ENTER:tree.nodeSetActive(ctx,true);break;case KC.BACKSPACE:case KC.LEFT:case KC.RIGHT:case KC.UP:case KC.DOWN:res=node.navigate(event.which,activate);break;default:handled=false}if(handled)event.preventDefault()},nodeLoadChildren:function(ctx,source){var ajax,delay,tree=ctx.tree,node=ctx.node;if($.isFunction(source))source=source();if(source.url){ajax=$.extend({},ctx.options.ajax,
source);if(ajax.debugDelay){delay=ajax.debugDelay;if($.isArray(delay))delay=delay[0]+Math.random()*(delay[1]-delay[0]);node.debug("nodeLoadChildren waiting debug delay "+Math.round(delay)+"ms");ajax.debugDelay=false;source=$.Deferred(function(dfd){setTimeout(function(){$.ajax(ajax).done(function(){dfd.resolveWith(this,arguments)}).fail(function(){dfd.rejectWith(this,arguments)})},delay)})}else source=$.ajax(ajax);source=source.pipe(function(data,textStatus,jqXHR){var res;if(typeof data==="string")$.error("Ajax request returned a string (did you get the JSON dataType wrong?).");
if(ctx.options.postProcess){res=tree._triggerNodeEvent("postProcess",ctx,ctx.originalEvent,{response:data,dataType:this.dataType});data=$.isArray(res)?res:data}else if(data&&(data.hasOwnProperty("d")&&ctx.options.enableAspx))data=typeof data.d==="string"?$.parseJSON(data.d):data.d;return data},function(jqXHR,textStatus,errorThrown){return tree._makeHookContext(node,null,{error:jqXHR,args:Array.prototype.slice.call(arguments),message:errorThrown,details:jqXHR.status+": "+errorThrown})})}if($.isFunction(source.promise)){_assert(!node.isLoading());
node._isLoading=true;tree.nodeSetStatus(ctx,"loading");source.done(function(){tree.nodeSetStatus(ctx,"ok")}).fail(function(error){var ctxErr;if(error.node&&(error.error&&error.message))ctxErr=error;else ctxErr=tree._makeHookContext(node,null,{error:error,args:Array.prototype.slice.call(arguments),message:error?error.message||error.toString():""});tree._triggerNodeEvent("loaderror",ctxErr,null);tree.nodeSetStatus(ctx,"error",ctxErr.message,ctxErr.details)})}return $.when(source).done(function(children){var metaData;
if($.isPlainObject(children)){_assert($.isArray(children.children),"source must contain (or be) an array of children");_assert(node.isRoot(),"source may only be an object for root nodes");metaData=children;children=children.children;delete metaData.children;$.extend(tree.data,metaData)}_assert($.isArray(children),"expected array of children");node._setChildren(children);tree._triggerNodeEvent("loadChildren",node)}).always(function(){node._isLoading=false})},nodeLoadKeyPath:function(ctx,keyPathList){},
nodeRemoveChild:function(ctx,childNode){var idx,node=ctx.node,opts=ctx.options,subCtx=$.extend({},ctx,{node:childNode}),children=node.children;if(children.length===1){_assert(childNode===children[0]);return this.nodeRemoveChildren(ctx)}if(this.activeNode&&(childNode===this.activeNode||this.activeNode.isDescendantOf(childNode)))this.activeNode.setActive(false);if(this.focusNode&&(childNode===this.focusNode||this.focusNode.isDescendantOf(childNode)))this.focusNode=null;this.nodeRemoveMarkup(subCtx);
this.nodeRemoveChildren(subCtx);idx=$.inArray(childNode,children);_assert(idx>=0);childNode.visit(function(n){n.parent=null},true);if(opts.removeNode)opts.removeNode.call(ctx.tree,{type:"removeNode"},subCtx);children.splice(idx,1)},nodeRemoveChildMarkup:function(ctx){var node=ctx.node;if(node.ul){if(node.isRoot())$(node.ul).empty();else{$(node.ul).remove();node.ul=null}node.visit(function(n){n.li=n.ul=null})}},nodeRemoveChildren:function(ctx){var subCtx,node=ctx.node,children=node.children,opts=ctx.options;
if(!children)return;if(this.activeNode&&this.activeNode.isDescendantOf(node))this.activeNode.setActive(false);if(this.focusNode&&this.focusNode.isDescendantOf(node))this.focusNode=null;this.nodeRemoveChildMarkup(ctx);subCtx=$.extend({},ctx);node.visit(function(n){n.parent=null;if(opts.removeNode){subCtx.node=n;opts.removeNode.call(ctx.tree,{type:"removeNode"},subCtx)}});if(node.lazy)node.children=[];else node.children=null;this.nodeRenderStatus(ctx)},nodeRemoveMarkup:function(ctx){var node=ctx.node;
if(node.li){$(node.li).remove();node.li=null}this.nodeRemoveChildMarkup(ctx)},nodeRender:function(ctx,force,deep,collapsed,_recursive){var childLI,childNode1,childNode2,i,l,next,subCtx,node=ctx.node,tree=ctx.tree,opts=ctx.options,aria=opts.aria,firstTime=false,parent=node.parent,isRootNode=!parent,children=node.children;if(!isRootNode&&!parent.ul)return;_assert(isRootNode||parent.ul,"parent UL must exist");if(!isRootNode){if(node.li&&(force||node.li.parentNode!==node.parent.ul)){if(node.li.parentNode!==
node.parent.ul)this.warn("unlink "+node+" (must be child of "+node.parent+")");this.nodeRemoveMarkup(ctx)}if(!node.li){firstTime=true;node.li=document.createElement("li");node.li.ftnode=node;if(aria);if(node.key&&opts.generateIds)node.li.id=opts.idPrefix+node.key;node.span=document.createElement("span");node.span.className="fancytree-node";if(aria)$(node.span).attr("aria-labelledby","ftal_"+node.key);node.li.appendChild(node.span);this.nodeRenderTitle(ctx);if(opts.createNode)opts.createNode.call(tree,
{type:"createNode"},ctx)}else this.nodeRenderStatus(ctx);if(opts.renderNode)opts.renderNode.call(tree,{type:"renderNode"},ctx)}if(children){if(isRootNode||(node.expanded||deep===true)){if(!node.ul){node.ul=document.createElement("ul");if(collapsed===true&&!_recursive||!node.expanded)node.ul.style.display="none";if(aria)$(node.ul).attr("role","group");if(node.li)node.li.appendChild(node.ul);else node.tree.$div.append(node.ul)}for(i=0,l=children.length;i<l;i++){subCtx=$.extend({},ctx,{node:children[i]});
this.nodeRender(subCtx,force,deep,false,true)}childLI=node.ul.firstChild;while(childLI){childNode2=childLI.ftnode;if(childNode2&&childNode2.parent!==node){node.debug("_fixParent: remove missing "+childNode2,childLI);next=childLI.nextSibling;childLI.parentNode.removeChild(childLI);childLI=next}else childLI=childLI.nextSibling}childLI=node.ul.firstChild;for(i=0,l=children.length-1;i<l;i++){childNode1=children[i];childNode2=childLI.ftnode;if(childNode1!==childNode2)node.ul.insertBefore(childNode1.li,
childNode2.li);else childLI=childLI.nextSibling}}}else if(node.ul){this.warn("remove child markup for "+node);this.nodeRemoveChildMarkup(ctx)}if(!isRootNode)if(firstTime)parent.ul.appendChild(node.li)},nodeRenderTitle:function(ctx,title){var id,imageSrc,nodeTitle,role,tabindex,tooltip,node=ctx.node,tree=ctx.tree,opts=ctx.options,aria=opts.aria,level=node.getLevel(),ares=[],icon=node.data.icon;if(title!==undefined)node.title=title;if(!node.span)return;if(level<opts.minExpandLevel){if(level>1)if(aria)ares.push("<span role='button' class='fancytree-expander'></span>");
else ares.push("<span class='fancytree-expander'></span>")}else if(aria)ares.push("<span role='button' class='fancytree-expander'></span>");else ares.push("<span class='fancytree-expander'></span>");if(opts.checkbox&&(node.hideCheckbox!==true&&!node.isStatusNode()))if(aria)ares.push("<span role='checkbox' class='fancytree-checkbox'></span>");else ares.push("<span class='fancytree-checkbox'></span>");role=aria?" role='img'":"";if(icon&&typeof icon==="string"){imageSrc=icon.charAt(0)==="/"?icon:opts.imagePath+
icon;ares.push("<img src='"+imageSrc+"' alt='' />")}else if(node.data.iconclass)ares.push("<span "+role+" class='fancytree-custom-icon"+" "+node.data.iconclass+"'></span>");else if(icon===true||icon!==false&&opts.icons!==false)ares.push("<span "+role+" class='fancytree-icon'></span>");nodeTitle="";if(opts.renderTitle)nodeTitle=opts.renderTitle.call(tree,{type:"renderTitle"},ctx)||"";if(!nodeTitle){tooltip=node.tooltip?" title='"+node.tooltip.replace(/\"/g,"&quot;")+"'":"";id=aria?" id='ftal_"+node.key+
"'":"";role=aria?" role='treeitem'":"";tabindex=opts.titlesTabbable?" tabindex='0'":"";nodeTitle="<span "+role+" class='fancytree-title'"+id+tooltip+tabindex+">"+node.title+"</span>"}ares.push(nodeTitle);node.span.innerHTML=ares.join("");this.nodeRenderStatus(ctx)},nodeRenderStatus:function(ctx){var node=ctx.node,tree=ctx.tree,opts=ctx.options,hasChildren=node.hasChildren(),isLastSib=node.isLastSibling(),aria=opts.aria,$ariaElem=$(node.span).find(".fancytree-title"),cn=opts._classNames,cnList=[],
statusElem=node[tree.statusClassPropName];if(!statusElem)return;cnList.push(cn.node);if(tree.activeNode===node)cnList.push(cn.active);else;if(tree.focusNode===node){cnList.push(cn.focused);if(aria)$ariaElem.attr("aria-activedescendant",true)}else if(aria)$ariaElem.removeAttr("aria-activedescendant");if(node.expanded){cnList.push(cn.expanded);if(aria)$ariaElem.attr("aria-expanded",true)}else if(aria)$ariaElem.removeAttr("aria-expanded");if(node.folder)cnList.push(cn.folder);if(hasChildren!==false)cnList.push(cn.hasChildren);
if(isLastSib)cnList.push(cn.lastsib);if(node.lazy&&node.children==null)cnList.push(cn.lazy);if(node.partsel)cnList.push(cn.partsel);if(node.selected){cnList.push(cn.selected);if(aria)$ariaElem.attr("aria-selected",true)}else if(aria)$ariaElem.attr("aria-selected",false);if(node.extraClasses)cnList.push(node.extraClasses);if(hasChildren===false)cnList.push(cn.combinedExpanderPrefix+"n"+(isLastSib?"l":""));else cnList.push(cn.combinedExpanderPrefix+(node.expanded?"e":"c")+(node.lazy&&node.children==
null?"d":"")+(isLastSib?"l":""));cnList.push(cn.combinedIconPrefix+(node.expanded?"e":"c")+(node.folder?"f":""));statusElem.className=cnList.join(" ");if(node.li)node.li.className=isLastSib?cn.lastsib:""},nodeSetActive:function(ctx,flag,callOpts){callOpts=callOpts||{};var subCtx,node=ctx.node,tree=ctx.tree,opts=ctx.options,noEvents=callOpts.noEvents===true,isActive=node===tree.activeNode;flag=flag!==false;if(isActive===flag)return _getResolvedPromise(node);else if(flag&&(!noEvents&&this._triggerNodeEvent("beforeActivate",
node,ctx.originalEvent)===false))return _getRejectedPromise(node,["rejected"]);if(flag){if(tree.activeNode){_assert(tree.activeNode!==node,"node was active (inconsistency)");subCtx=$.extend({},ctx,{node:tree.activeNode});tree.nodeSetActive(subCtx,false);_assert(tree.activeNode===null,"deactivate was out of sync?")}if(opts.activeVisible)node.makeVisible();tree.activeNode=node;tree.nodeRenderStatus(ctx);tree.nodeSetFocus(ctx);if(!noEvents)tree._triggerNodeEvent("activate",node)}else{_assert(tree.activeNode===
node,"node was not active (inconsistency)");tree.activeNode=null;this.nodeRenderStatus(ctx);if(!noEvents)ctx.tree._triggerNodeEvent("deactivate",node)}},nodeSetExpanded:function(ctx,flag,callOpts){callOpts=callOpts||{};var _afterLoad,dfd,i,l,parents,prevAC,node=ctx.node,tree=ctx.tree,opts=ctx.options,noAnimation=callOpts.noAnimation===true,noEvents=callOpts.noEvents===true;flag=flag!==false;if(node.expanded&&flag||!node.expanded&&!flag)return _getResolvedPromise(node);else if(flag&&(!node.lazy&&!node.hasChildren()))return _getResolvedPromise(node);
else if(!flag&&node.getLevel()<opts.minExpandLevel)return _getRejectedPromise(node,["locked"]);else if(!noEvents&&this._triggerNodeEvent("beforeExpand",node,ctx.originalEvent)===false)return _getRejectedPromise(node,["rejected"]);if(!noAnimation&&!node.isVisible())noAnimation=callOpts.noAnimation=true;dfd=new $.Deferred;if(flag&&(!node.expanded&&opts.autoCollapse)){parents=node.getParentList(false,true);prevAC=opts.autoCollapse;try{opts.autoCollapse=false;for(i=0,l=parents.length;i<l;i++)this._callHook("nodeCollapseSiblings",
parents[i],callOpts)}finally{opts.autoCollapse=prevAC}}dfd.done(function(){if(!noEvents)ctx.tree._triggerNodeEvent(flag?"expand":"collapse",ctx);if(opts.autoScroll&&(!noAnimation&&node.hasChildren()))node.getLastChild().scrollIntoView(true,node)});_afterLoad=function(callback){var duration,easing,isVisible,isExpanded;node.expanded=flag;tree._callHook("nodeRender",ctx,false,false,true);if(node.ul){isVisible=node.ul.style.display!=="none";isExpanded=!!node.expanded;if(isVisible===isExpanded)node.warn("nodeSetExpanded: UL.style.display already set");
else if(!opts.fx||noAnimation)node.ul.style.display=node.expanded||!parent?"":"none";else{duration=opts.fx.duration||200;easing=opts.fx.easing;$(node.ul).animate(opts.fx,duration,easing,function(){callback()});return}}callback()};if(flag&&(node.lazy&&node.hasChildren()===undefined))node.load().done(function(){if(dfd.notifyWith)dfd.notifyWith(node,["loaded"]);_afterLoad(function(){dfd.resolveWith(node)})}).fail(function(errMsg){_afterLoad(function(){dfd.rejectWith(node,["load failed ("+errMsg+")"])})});
else _afterLoad(function(){dfd.resolveWith(node)});return dfd.promise()},nodeSetFocus:function(ctx,flag){var ctx2,tree=ctx.tree,node=ctx.node;flag=flag!==false;if(tree.focusNode){if(tree.focusNode===node&&flag)return;ctx2=$.extend({},ctx,{node:tree.focusNode});tree.focusNode=null;this._triggerNodeEvent("blur",ctx2);this._callHook("nodeRenderStatus",ctx2)}if(flag){if(!this.hasFocus()){node.debug("nodeSetFocus: forcing container focus");this._callHook("treeSetFocus",ctx,true,true)}node.makeVisible();
tree.focusNode=node;this._triggerNodeEvent("focus",ctx);if(ctx.options.autoScroll)node.scrollIntoView();this._callHook("nodeRenderStatus",ctx)}},nodeSetSelected:function(ctx,flag){var node=ctx.node,tree=ctx.tree,opts=ctx.options;flag=flag!==false;node.debug("nodeSetSelected("+flag+")",ctx);if(node.unselectable)return;if(node.selected&&flag||!node.selected&&!flag)return!!node.selected;else if(this._triggerNodeEvent("beforeSelect",node,ctx.originalEvent)===false)return!!node.selected;if(flag&&opts.selectMode===
1){if(tree.lastSelectedNode)tree.lastSelectedNode.setSelected(false)}else if(opts.selectMode===3){node.selected=flag;node.fixSelection3AfterClick()}node.selected=flag;this.nodeRenderStatus(ctx);tree.lastSelectedNode=flag?node:null;tree._triggerNodeEvent("select",ctx)},nodeSetStatus:function(ctx,status,message,details){var node=ctx.node,tree=ctx.tree,cn=ctx.options._classNames;function _clearStatusNode(){var firstChild=node.children?node.children[0]:null;if(firstChild&&firstChild.isStatusNode()){try{if(node.ul){node.ul.removeChild(firstChild.li);
firstChild.li=null}}catch(e){}if(node.children.length===1)node.children=[];else node.children.shift()}}function _setStatusNode(data,type){var firstChild=node.children?node.children[0]:null;if(firstChild&&firstChild.isStatusNode()){$.extend(firstChild,data);tree._callHook("nodeRender",firstChild)}else{data.key="_statusNode";node._setChildren([data]);node.children[0].statusNodeType=type;tree.render()}return node.children[0]}switch(status){case "ok":_clearStatusNode();$(node.span).removeClass(cn.loading);
$(node.span).removeClass(cn.error);break;case "loading":$(node.span).removeClass(cn.error);$(node.span).addClass(cn.loading);if(!node.parent)_setStatusNode({title:tree.options.strings.loading+(message?" ("+message+") ":""),tooltip:details,extraClasses:"fancytree-statusnode-wait"},status);break;case "error":$(node.span).removeClass(cn.loading);$(node.span).addClass(cn.error);_setStatusNode({title:tree.options.strings.loadError+(message?" ("+message+") ":""),tooltip:details,extraClasses:"fancytree-statusnode-error"},
status);break;default:$.error("invalid status "+status)}},nodeToggleExpanded:function(ctx){return this.nodeSetExpanded(ctx,!ctx.node.expanded)},nodeToggleSelected:function(ctx){return this.nodeSetSelected(ctx,!ctx.node.selected)},treeClear:function(ctx){var tree=ctx.tree;tree.activeNode=null;tree.focusNode=null;tree.$div.find(">ul.fancytree-container").empty();tree.rootNode.children=null},treeCreate:function(ctx){},treeDestroy:function(ctx){},treeInit:function(ctx){this.treeLoad(ctx)},treeLoad:function(ctx,
source){var type,$ul,tree=ctx.tree,$container=ctx.widget.element,dfd,rootCtx=$.extend({},ctx,{node:this.rootNode});if(tree.rootNode.children)this.treeClear(ctx);source=source||this.options.source;if(!source){type=$container.data("type")||"html";switch(type){case "html":$ul=$container.find(">ul:first");$ul.addClass("ui-fancytree-source ui-helper-hidden");source=$.ui.fancytree.parseHtml($ul);break;case "json":source=$.parseJSON($container.text());if(source.children){if(source.title)tree.title=source.title;
source=source.children}break;default:$.error("Invalid data-type: "+type)}}else if(typeof source==="string")_raiseNotImplemented();dfd=this.nodeLoadChildren(rootCtx,source).done(function(){tree.render();if(ctx.options.selectMode===3)tree.rootNode.fixSelection3FromEndNodes();tree._triggerTreeEvent("init",true)}).fail(function(){tree.render();tree._triggerTreeEvent("init",false)});return dfd},treeSetFocus:function(ctx,flag,_calledByNodeSetFocus){flag=flag!==false;if(flag!==this.hasFocus()){this._hasFocus=
flag;this.$container.toggleClass("fancytree-treefocus",flag);this._triggerTreeEvent(flag?"focusTree":"blurTree")}}});$.widget("ui.fancytree",{options:{activeVisible:true,ajax:{type:"GET",cache:false,dataType:"json"},aria:false,autoActivate:true,autoCollapse:false,autoScroll:false,checkbox:false,clickFolderMode:4,debugLevel:null,disabled:false,enableAspx:true,extensions:[],fx:{height:"toggle",duration:200},generateIds:false,icons:true,idPrefix:"ft_",keyboard:true,keyPathSeparator:"/",minExpandLevel:1,
selectMode:2,strings:{loading:"Loading&#8230;",loadError:"Load error!"},tabbable:true,titlesTabbable:false,_classNames:{node:"fancytree-node",folder:"fancytree-folder",combinedExpanderPrefix:"fancytree-exp-",combinedIconPrefix:"fancytree-ico-",hasChildren:"fancytree-has-children",active:"fancytree-active",selected:"fancytree-selected",expanded:"fancytree-expanded",lazy:"fancytree-lazy",focused:"fancytree-focused",partsel:"fancytree-partsel",lastsib:"fancytree-lastsib",loading:"fancytree-loading",
error:"fancytree-error"},lazyLoad:null,postProcess:null},_create:function(){this.tree=new Fancytree(this);this.$source=this.source||this.element.data("type")==="json"?this.element:this.element.find(">ul:first");var extension,extName,i,extensions=this.options.extensions,base=this.tree;for(i=0;i<extensions.length;i++){extName=extensions[i];extension=$.ui.fancytree._extensions[extName];if(!extension)$.error("Could not apply extension '"+extName+"' (it is not registered, did you forget to include it?)");
this.tree.options[extName]=$.extend(true,{},extension.options,this.tree.options[extName]);_assert(this.tree.ext[extName]===undefined,"Extension name must not exist as Fancytree.ext attribute: '"+extName+"'");this.tree.ext[extName]={};_subclassObject(this.tree,base,extension,extName);base=extension}this.tree._callHook("treeCreate",this.tree)},_init:function(){this.tree._callHook("treeInit",this.tree);this._bind()},_setOption:function(key,value){var callDefault=true,rerender=false;switch(key){case "aria":case "checkbox":case "icons":case "minExpandLevel":case "tabbable":this.tree._callHook("treeCreate",
this.tree);rerender=true;break;case "source":callDefault=false;this.tree._callHook("treeLoad",this.tree,value);break}this.tree.debug("set option "+key+"="+value+" <"+typeof value+">");if(callDefault)$.Widget.prototype._setOption.apply(this,arguments);if(rerender)this.tree.render(true,false)},destroy:function(){this._unbind();this.tree._callHook("treeDestroy",this.tree);this.tree.$div.find(">ul.fancytree-container").remove();this.$source&&this.$source.removeClass("ui-helper-hidden");$.Widget.prototype.destroy.call(this)},
_unbind:function(){var ns=this.tree._ns;this.element.unbind(ns);this.tree.$container.unbind(ns);$(document).unbind(ns)},_bind:function(){var that=this,opts=this.options,tree=this.tree,ns=tree._ns;this._unbind();tree.$container.on("focusin"+ns+" focusout"+ns,function(event){var node=FT.getNode(event),flag=event.type==="focusin";if(node)tree._callHook("nodeSetFocus",node,flag);else tree._callHook("treeSetFocus",tree,flag)}).on("selectstart"+ns,"span.fancytree-title",function(event){event.preventDefault()}).on("keydown"+
ns,function(event){if(opts.disabled||opts.keyboard===false)return true;var res,node=tree.focusNode,ctx=tree._makeHookContext(node||tree,event),prevPhase=tree.phase;try{tree.phase="userEvent";if(node)res=tree._triggerNodeEvent("keydown",node,event);else res=tree._triggerTreeEvent("keydown",event);if(res==="preventNav")res=true;else if(res!==false)res=tree._callHook("nodeKeydown",ctx);return res}finally{tree.phase=prevPhase}}).on("click"+ns+" dblclick"+ns,function(event){if(opts.disabled)return true;
var ctx,et=FT.getEventTarget(event),node=et.node,tree=that.tree,prevPhase=tree.phase;if(!node)return true;ctx=tree._makeHookContext(node,event);try{tree.phase="userEvent";switch(event.type){case "click":ctx.targetType=et.type;return tree._triggerNodeEvent("click",ctx,event)===false?false:tree._callHook("nodeClick",ctx);case "dblclick":ctx.targetType=et.type;return tree._triggerNodeEvent("dblclick",ctx,event)===false?false:tree._callHook("nodeDblclick",ctx)}}finally{tree.phase=prevPhase}})},getActiveNode:function(){return this.tree.activeNode},
getNodeByKey:function(key){return this.tree.getNodeByKey(key)},getRootNode:function(){return this.tree.rootNode},getTree:function(){return this.tree}});FT=$.ui.fancytree;$.extend($.ui.fancytree,{version:"development",buildType:"develop",debugLevel:2,_nextId:1,_nextNodeKey:1,_extensions:{},_FancytreeClass:Fancytree,_FancytreeNodeClass:FancytreeNode,jquerySupports:{positionMyOfs:isVersionAtLeast($.ui.version,1,9)},assert:function(cond,msg){return _assert(cond,msg)},debug:function(msg){$.ui.fancytree.debugLevel>=
2&&consoleApply("log",arguments)},error:function(msg){consoleApply("error",arguments)},getEventTargetType:function(event){return this.getEventTarget(event).type},getEventTarget:function(event){var tcn=event&&event.target?event.target.className:"",res={node:this.getNode(event.target),type:undefined};if(/\bfancytree-title\b/.test(tcn))res.type="title";else if(/\bfancytree-expander\b/.test(tcn))res.type=res.node.hasChildren()===false?"prefix":"expander";else if(/\bfancytree-checkbox\b/.test(tcn)||/\bfancytree-radio\b/.test(tcn))res.type=
"checkbox";else if(/\bfancytree-icon\b/.test(tcn))res.type="icon";else if(/\bfancytree-node\b/.test(tcn))res.type="title";return res},getNode:function(el){if(el instanceof FancytreeNode)return el;else if(el.selector!==undefined)el=el[0];else if(el.originalEvent!==undefined)el=el.target;while(el){if(el.ftnode)return el.ftnode;el=el.parentNode}return null},info:function(msg){$.ui.fancytree.debugLevel>=1&&consoleApply("info",arguments)},parseHtml:function($ul){var $children=$ul.find(">li"),extraClasses,
i,l,iPos,tmp,classes,className,children=[];$children.each(function(){var allData,jsonData,$li=$(this),$liSpan=$li.find(">span:first",this),$liA=$liSpan.length?null:$li.find(">a:first"),d={tooltip:null,data:{}};if($liSpan.length)d.title=$liSpan.html();else if($liA&&$liA.length){d.title=$liA.html();d.data.href=$liA.attr("href");d.data.target=$liA.attr("target");d.tooltip=$liA.attr("title")}else{d.title=$li.html();iPos=d.title.search(/<ul/i);if(iPos>=0)d.title=d.title.substring(0,iPos)}d.title=$.trim(d.title);
for(i=0,l=CLASS_ATTRS.length;i<l;i++)d[CLASS_ATTRS[i]]=undefined;classes=this.className.split(" ");extraClasses=[];for(i=0,l=classes.length;i<l;i++){className=classes[i];if(CLASS_ATTR_MAP[className])d[className]=true;else extraClasses.push(className)}d.extraClasses=extraClasses.join(" ");tmp=$li.attr("title");if(tmp)d.tooltip=tmp;tmp=$li.attr("id");if(tmp)d.key=tmp;allData=$li.data();if(allData&&!$.isEmptyObject(allData)){jsonData=allData.json;delete allData.json;$.extend(d.data,allData);if(jsonData)$.extend(d.data,
jsonData)}$ul=$li.find(">ul:first");if($ul.length)d.children=$.ui.fancytree.parseHtml($ul);else d.children=d.lazy?undefined:null;children.push(d)});return children},registerExtension:function(definition){_assert(definition.name!=null,"extensions must have a `name` property.");_assert(definition.version!=null,"extensions must have a `version` property.");$.ui.fancytree._extensions[definition.name]=definition},warn:function(msg){consoleApply("warn",arguments)}})})(jQuery,window,document);
(function($,window,document,undefined){function _getIcon(opts,type){return opts.map[type]}$.ui.fancytree.registerExtension({name:"glyph",version:"0.0.1",options:{prefix:"icon-",extra:null,map:{doc:"icon-file-alt",docOpen:"icon-file-alt",checkbox:"icon-check-empty",checkboxSelected:"icon-check",checkboxUnknown:"icon-check icon-muted",error:"icon-exclamation-sign",expanderClosed:"icon-caret-right",expanderLazy:"icon-angle-right",expanderOpen:"icon-caret-down",folder:"icon-folder-close-alt",folderOpen:"icon-folder-open-alt",
loading:"icon-refresh icon-spin"},icon:null},treeInit:function(ctx){var tree=ctx.tree;this._super(ctx);tree.$container.addClass("fancytree-ext-glyph")},nodeRenderStatus:function(ctx){var icon,span,node=ctx.node,opts=ctx.options.glyph,map=opts.map;this._super(ctx);if(node.isRoot())return;span=$("span.fancytree-expander",node.span).get(0);if(span){if(node.isLoading())icon="loading";else if(node.expanded)icon="expanderOpen";else if(node.isUndefined())icon="expanderLazy";else icon="expanderClosed";span.className=
"fancytree-expander "+map[icon]}span=$("span.fancytree-checkbox",node.span).get(0);if(span){icon=node.selected?"checkboxSelected":node.partsel?"checkboxUnknown":"checkbox";span.className="fancytree-checkbox "+map[icon]}span=$("span.fancytree-icon",node.span).get(0);if(span){if(node.folder)icon=node.expanded?_getIcon(opts,"folderOpen"):_getIcon(opts,"folder");else icon=node.expanded?_getIcon(opts,"docOpen"):_getIcon(opts,"doc");span.className="fancytree-icon "+icon}},nodeSetStatus:function(ctx,status,
message,details){var span,opts=ctx.options.glyph,node=ctx.node;this._super(ctx,status,message,details);if(node.parent)span=$("span.fancytree-expander",node.span).get(0);else span=$("span.fancytree-statusnode-wait, span.fancytree-statusnode-error",node.span).find("span.fancytree-expander").get(0);if(status==="loading")span.className="fancytree-expander "+_getIcon(opts,"loading");else if(status==="error")span.className="fancytree-expander "+_getIcon(opts,"error")}})})(jQuery,window,document);
(function($,undefined){$.ui.fancytree._FancytreeClass.prototype.countSelected=function(topOnly){var tree=this,treeOptions=tree.options;return tree.getSelectedNodes(topOnly).length};$.ui.fancytree._FancytreeNodeClass.prototype.toUpper=function(){var node=this;return node.setTitle(node.title.toUpperCase())};$.ui.fancytree.prototype.widgetMethod1=function(arg1){var tree=this.tree;return arg1};$.ui.fancytree.registerExtension({name:"childcounter",version:"1.0.0",options:{deep:true,hideZeros:true,hideExpanded:false},
foo:42,_appendCounter:function(bar){var tree=this},treeInit:function(ctx){var tree=this,opts=ctx.options,extOpts=ctx.options.childcounter;this._super(ctx);this.$container.addClass("fancytree-ext-childcounter")},treeDestroy:function(ctx){this._super(ctx)},nodeRenderTitle:function(ctx,title){var node=ctx.node,extOpts=ctx.options.childcounter,count=node.countChildren(extOpts.deep);this._super(ctx,title);if((count||!extOpts.hideZeros)&&(!node.isExpanded()||!extOpts.hideExpanded))$("span.fancytree-icon",
node.span).append($("<span class='fancytree-childcounter'/>").text(count))},nodeSetExpanded:function(ctx,flag,opts){var tree=ctx.tree,node=ctx.node;return this._super(ctx,flag,opts).always(function(){tree.nodeRenderTitle(ctx)})}})})(jQuery);
(function($,window,document,undefined){var logMsg=$.ui.fancytree.debug,didRegisterDnd=false;function offsetString(n){return n===0?"":n>0?"+"+n:""+n}function _initDragAndDrop(tree){var dnd=tree.options.dnd||null;if(dnd)_registerDnd();if(dnd&&dnd.dragStart)tree.widget.element.draggable({addClasses:false,appendTo:"body",containment:false,delay:0,distance:4,revert:false,scroll:true,scrollSpeed:7,scrollSensitivity:10,connectToFancytree:true,helper:function(event){var sourceNode=$.ui.fancytree.getNode(event.target);
if(!sourceNode)return"<div>ERROR?: helper requested but sourceNode not found</div>";return sourceNode.tree.ext.dnd._onDragEvent("helper",sourceNode,null,event,null,null)},start:function(event,ui){var sourceNode=ui.helper.data("ftSourceNode");return!!sourceNode}});if(dnd&&dnd.dragDrop)tree.widget.element.droppable({addClasses:false,tolerance:"intersect",greedy:false})}function _registerDnd(){if(didRegisterDnd)return;$.ui.plugin.add("draggable","connectToFancytree",{start:function(event,ui){var draggable=
$(this).data("ui-draggable")||$(this).data("draggable"),sourceNode=ui.helper.data("ftSourceNode")||null;if(sourceNode){draggable.offset.click.top=-2;draggable.offset.click.left=+16;return sourceNode.tree.ext.dnd._onDragEvent("start",sourceNode,null,event,ui,draggable)}},drag:function(event,ui){var isHelper,draggable=$(this).data("ui-draggable")||$(this).data("draggable"),sourceNode=ui.helper.data("ftSourceNode")||null,prevTargetNode=ui.helper.data("ftTargetNode")||null,targetNode=$.ui.fancytree.getNode(event.target);
if(event.target&&!targetNode){isHelper=$(event.target).closest("div.fancytree-drag-helper,#fancytree-drop-marker").length>0;if(isHelper){logMsg("Drag event over helper: ignored.");return}}ui.helper.data("ftTargetNode",targetNode);if(prevTargetNode&&prevTargetNode!==targetNode)prevTargetNode.tree.ext.dnd._onDragEvent("leave",prevTargetNode,sourceNode,event,ui,draggable);if(targetNode)if(!targetNode.tree.options.dnd.dragDrop);else if(targetNode===prevTargetNode)targetNode.tree.ext.dnd._onDragEvent("over",
targetNode,sourceNode,event,ui,draggable);else targetNode.tree.ext.dnd._onDragEvent("enter",targetNode,sourceNode,event,ui,draggable)},stop:function(event,ui){var draggable=$(this).data("ui-draggable")||$(this).data("draggable"),sourceNode=ui.helper.data("ftSourceNode")||null,targetNode=ui.helper.data("ftTargetNode")||null,eventType=event.type,dropped=eventType==="mouseup"&&event.which===1;if(!dropped)logMsg("Drag was cancelled");if(targetNode){if(dropped)targetNode.tree.ext.dnd._onDragEvent("drop",
targetNode,sourceNode,event,ui,draggable);targetNode.tree.ext.dnd._onDragEvent("leave",targetNode,sourceNode,event,ui,draggable)}if(sourceNode)sourceNode.tree.ext.dnd._onDragEvent("stop",sourceNode,null,event,ui,draggable)}});didRegisterDnd=true}$.ui.fancytree.registerExtension({name:"dnd",version:"0.1.0",options:{dragStart:null,dragStop:null,autoExpandMS:1E3,preventVoidMoves:true,preventRecursiveMoves:true,dragEnter:null,dragOver:null,dragDrop:null,dragLeave:null},treeInit:function(ctx){var tree=
ctx.tree;this._super(ctx);_initDragAndDrop(tree)},nodeKeydown:function(ctx){var event=ctx.originalEvent;if(event.which===$.ui.keyCode.ESCAPE)this._local._cancelDrag();return this._super(ctx)},_setDndStatus:function(sourceNode,targetNode,helper,hitMode,accept){var posOpts,markerOffsetX=0,markerAt="center",instData=this._local,$source=sourceNode?$(sourceNode.span):null,$target=$(targetNode.span);if(!instData.$dropMarker)instData.$dropMarker=$("<div id='fancytree-drop-marker'></div>").hide().css({"z-index":1E3}).prependTo($(this.$div).parent());
if(hitMode==="after"||(hitMode==="before"||hitMode==="over")){switch(hitMode){case "before":instData.$dropMarker.removeClass("fancytree-drop-after fancytree-drop-over");instData.$dropMarker.addClass("fancytree-drop-before");markerAt="top";break;case "after":instData.$dropMarker.removeClass("fancytree-drop-before fancytree-drop-over");instData.$dropMarker.addClass("fancytree-drop-after");markerAt="bottom";break;default:instData.$dropMarker.removeClass("fancytree-drop-after fancytree-drop-before");
instData.$dropMarker.addClass("fancytree-drop-over");$target.addClass("fancytree-drop-target");markerOffsetX=8}if($.ui.fancytree.jquerySupports.positionMyOfs)posOpts={my:"left"+offsetString(markerOffsetX)+" center",at:"left "+markerAt,of:$target};else posOpts={my:"left center",at:"left "+markerAt,of:$target,offset:""+markerOffsetX+" 0"};instData.$dropMarker.show().position(posOpts)}else{$target.removeClass("fancytree-drop-target");instData.$dropMarker.hide()}if(hitMode==="after")$target.addClass("fancytree-drop-after");
else $target.removeClass("fancytree-drop-after");if(hitMode==="before")$target.addClass("fancytree-drop-before");else $target.removeClass("fancytree-drop-before");if(accept===true){if($source)$source.addClass("fancytree-drop-accept");$target.addClass("fancytree-drop-accept");helper.addClass("fancytree-drop-accept")}else{if($source)$source.removeClass("fancytree-drop-accept");$target.removeClass("fancytree-drop-accept");helper.removeClass("fancytree-drop-accept")}if(accept===false){if($source)$source.addClass("fancytree-drop-reject");
$target.addClass("fancytree-drop-reject");helper.addClass("fancytree-drop-reject")}else{if($source)$source.removeClass("fancytree-drop-reject");$target.removeClass("fancytree-drop-reject");helper.removeClass("fancytree-drop-reject")}},_onDragEvent:function(eventName,node,otherNode,event,ui,draggable){if(eventName!=="over")logMsg("tree.ext.dnd._onDragEvent(%s, %o, %o) - %o",eventName,node,otherNode,this);var $helper,nodeOfs,relPos,relPos2,enterResponse,hitMode,r,opts=this.options,dnd=opts.dnd,ctx=
this._makeHookContext(node,event,{otherNode:otherNode,ui:ui,draggable:draggable}),res=null,nodeTag=$(node.span);switch(eventName){case "helper":$helper=$("<div class='fancytree-drag-helper'><span class='fancytree-drag-helper-img' /></div>").append(nodeTag.find("span.fancytree-title").clone());$("ul.fancytree-container",node.tree.$div).append($helper);$helper.data("ftSourceNode",node);res=$helper;break;case "start":if(node.isStatusNode())res=false;else if(dnd.dragStart)res=dnd.dragStart(node,ctx);
if(res===false){this.debug("tree.dragStart() cancelled");ui.helper.trigger("mouseup");ui.helper.hide()}else nodeTag.addClass("fancytree-drag-source");break;case "enter":if(dnd.preventRecursiveMoves&&node.isDescendantOf(otherNode))r=false;else r=dnd.dragEnter?dnd.dragEnter(node,ctx):null;if(!r)res=false;else if($.isArray(r))res={over:$.inArray("over",r)>=0,before:$.inArray("before",r)>=0,after:$.inArray("after",r)>=0};else res={over:r===true||r==="over",before:r===true||r==="before",after:r===true||
r==="after"};ui.helper.data("enterResponse",res);logMsg("helper.enterResponse: %o",res);break;case "over":enterResponse=ui.helper.data("enterResponse");hitMode=null;if(enterResponse===false);else if(typeof enterResponse==="string")hitMode=enterResponse;else{nodeOfs=nodeTag.offset();relPos={x:event.pageX-nodeOfs.left,y:event.pageY-nodeOfs.top};relPos2={x:relPos.x/nodeTag.width(),y:relPos.y/nodeTag.height()};if(enterResponse.after&&relPos2.y>0.75)hitMode="after";else if(!enterResponse.over&&(enterResponse.after&&
relPos2.y>0.5))hitMode="after";else if(enterResponse.before&&relPos2.y<=0.25)hitMode="before";else if(!enterResponse.over&&(enterResponse.before&&relPos2.y<=0.5))hitMode="before";else if(enterResponse.over)hitMode="over";if(dnd.preventVoidMoves)if(node===otherNode){logMsg("    drop over source node prevented");hitMode=null}else if(hitMode==="before"&&(otherNode&&node===otherNode.getNextSibling())){logMsg("    drop after source node prevented");hitMode=null}else if(hitMode==="after"&&(otherNode&&node===
otherNode.getPrevSibling())){logMsg("    drop before source node prevented");hitMode=null}else if(hitMode==="over"&&(otherNode&&(otherNode.parent===node&&otherNode.isLastSibling()))){logMsg("    drop last child over own parent prevented");hitMode=null}ui.helper.data("hitMode",hitMode)}if(hitMode==="over"&&(dnd.autoExpandMS&&(node.hasChildren()!==false&&!node.expanded)))node.scheduleAction("expand",dnd.autoExpandMS);if(hitMode&&dnd.dragOver){ctx.hitMode=hitMode;res=dnd.dragOver(node,ctx)}this._local._setDndStatus(otherNode,
node,ui.helper,hitMode,res!==false&&hitMode!==null);break;case "drop":hitMode=ui.helper.data("hitMode");if(hitMode&&dnd.dragDrop){ctx.hitMode=hitMode;dnd.dragDrop(node,ctx)}break;case "leave":node.scheduleAction("cancel");ui.helper.data("enterResponse",null);ui.helper.data("hitMode",null);this._local._setDndStatus(otherNode,node,ui.helper,"out",undefined);if(dnd.dragLeave)dnd.dragLeave(node,ctx);break;case "stop":nodeTag.removeClass("fancytree-drag-source");if(dnd.dragStop)dnd.dragStop(node,ctx);
break;default:throw"Unsupported drag event: "+eventName;}return res},_cancelDrag:function(){var dd=$.ui.ddmanager.current;if(dd)dd.cancel()}})})(jQuery,window,document);
(function($,window,document,undefined){function _escapeRegex(str){return(str+"").replace(/([.?*+\^\$\[\]\\(){}|-])/g,"\\$1")}$.ui.fancytree._FancytreeClass.prototype.applyFilter=function(filter){var match,re,count=0,leavesOnly=this.options.filter.leavesOnly;if(typeof filter==="string"){match=_escapeRegex(filter);re=new RegExp(".*"+match+".*","i");filter=function(node){return!!re.exec(node.title)}}this.enableFilter=true;this.$div.addClass("fancytree-ext-filter");if(this.options.filter.mode==="hide")this.$div.addClass("fancytree-ext-filter-hide");
else this.$div.addClass("fancytree-ext-filter-dimm");this.visit(function(node){node.hide=true;delete node.match;delete node.subMatch});this.visit(function(node){if((!leavesOnly||node.children==null)&&filter(node)){count++;node.hide=false;node.match=true;node.visitParents(function(p){p.hide=false;p.subMatch=true})}});this.render();return count};$.ui.fancytree._FancytreeClass.prototype.clearFilter=function(){this.visit(function(node){delete node.hide;delete node.match;delete node.subMatch});this.enableFilter=
false;this.$div.removeClass("fancytree-ext-filter fancytree-ext-filter-dimm fancytree-ext-filter-hide");this.render()};$.ui.fancytree.registerExtension({name:"filter",version:"0.0.2",options:{mode:"dimm",leavesOnly:false},treeInit:function(ctx){this._super(ctx)},treeDestroy:function(ctx){this._super(ctx)},nodeRenderStatus:function(ctx){var res,node=ctx.node,tree=ctx.tree,$span=$(node[tree.statusClassPropName]);res=this._super(ctx);if(!$span.length)return res;if(!tree.enableFilter)return res;$span.toggleClass("fancytree-match",
!!node.match);$span.toggleClass("fancytree-submatch",!!node.subMatch);$span.toggleClass("fancytree-hide",!!node.hide);return res}})})(jQuery,window,document);
